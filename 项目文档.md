# 显化导师 Agent 项目文档

## 项目概述
本项目旨在基于 OpenClaw + Telegram 构建一个“显化导师”Agent，特点是 Prompt 极简、长期记忆可持续、每天自动归档对话到 Notion，并提供独立后台用于配置个人画像与目标。部署环境为腾讯云，默认时区为 Asia/Shanghai (UTC+08:00)。

## 目标与非目标
目标
1. 以年为单位的长期记忆，不依赖上下文长度。
2. 每天 00:00 自动将当天对话原文写入 Notion 的父页面下的子页面。
3. 支持后台配置个人画像与目标，不依赖聊天解析。
4. 支持纯文本知识注入，并可被检索用于对话。
5. 以 OpenClaw 作为核心编排与工具调用框架。

非目标
1. 不做复杂的情绪分析或摘要处理。
2. 不做多用户、SaaS 化能力。
3. 不做前端复杂交互，仅提供最小后台配置页。

## 总体架构
组件
1. Telegram 作为对话入口。
2. OpenClaw 作为编排与工具调用层。
3. LLM 使用 Gemini 3 Flash。
4. 统一数据层：Postgres + pgvector。
5. Notion 作为每日对话归档载体。
6. 后台配置页用于修改用户画像。

关键设计
1. Prompt 极简，个性化与记忆依赖数据层完成。
2. 数据统一存储，向量检索与结构化查询在同一数据库完成。
3. Notion 写入为定时任务，不参与实时对话路径。

## 核心功能说明
### 1. 长期记忆
实现方式
1. 所有对话落库到 messages 表。
2. 生成向量并存储在 messages.embedding。
3. 对话时按时间窗口 + 语义相似度召回相关记忆。

优点
1. 低成本可持续扩展。
2. 召回覆盖“同义表达”的历史记忆。

限制
1. 需控制召回数量以避免上下文膨胀。
2. 超大规模时性能需调优。

### 2. 每日 Notion 归档
实现方式
1. 每天 00:00 运行定时任务。
2. 拉取前一天所有对话原文。
3. 生成 Notion 子页面，标题格式为 YYYY-MM-DD 聊天记录。
4. 页面内容为原始对话文本，不做摘要或改写。

优点
1. 实现简单，可追溯性强。
2. 易于人工回顾。

限制
1. 页面内容可能很大，后期 Notion 加载可能变慢。
2. 不利于统计与结构化检索。

### 3. 后台配置
实现方式
1. 独立小页面编辑 profiles 表。
2. 修改后立即影响对话召回和行为逻辑。
3. 通过鉴权或白名单限制访问。

优点
1. 可控、稳定、不依赖自然语言解析。
2. 适合长期维护。

限制
1. 需维护额外入口与权限。

### 4. 知识注入
实现方式
1. 用户以纯文本提交外部知识。
2. 文本分块并写入 knowledge_chunks 表。
3. 生成向量以支持语义检索。

## 数据模型（简要）
建议表
1. users
2. profiles
3. messages
4. knowledge_chunks
5. sync_jobs

字段示例
1. users: id, created_at
2. profiles: user_id, goals, status, preferences, updated_at
3. messages: id, user_id, role, content, created_at, embedding
4. knowledge_chunks: id, user_id, content, source, created_at, embedding
5. sync_jobs: id, job_type, date_key, status, created_at

## 关键流程
### 实时对话流程
1. Telegram 收到消息。
2. OpenClaw 接入并解析请求。
3. 从 profiles 获取当前画像。
4. 进行语义检索并召回历史记忆和知识片段。
5. 构造最小提示词并调用 Gemini 3 Flash。
6. 返回回复并写入 messages。

### 每日归档流程
1. 定时任务在 00:00 触发。
2. 查询前一天所有 messages。
3. 生成 Notion 子页面并写入原始对话。
4. 在 sync_jobs 标记当天已完成。

### 知识注入流程
1. 用户提交纯文本。
2. 存入 knowledge_chunks 并生成向量。
3. 后续对话按主题召回。

## 配置与部署
### 环境变量（建议）
1. DB_URL
2. TELEGRAM_BOT_TOKEN
3. NOTION_TOKEN
4. NOTION_PARENT_PAGE_ID
5. TIMEZONE=Asia/Shanghai
6. MODEL_PROVIDER=gemini
7. MODEL_NAME=gemini-3-flash
8. WEBHOOK_TOKEN

### 部署要点
1. OpenClaw Gateway 需 24/7 常驻。
2. 定时任务依赖 Gateway Cron。
3. 数据库需开启 pgvector 扩展。

## 安全与合规
1. 严格保护 Token 与数据库连接信息。
2. 后台配置页需鉴权或限制 IP。
3. 生产环境禁用调试日志输出敏感信息。

## 运行与维护
1. 数据库按月分区 messages 表提升性能。
2. 定期备份数据库与 Notion 页面。
3. 监控任务失败与重试情况。

## 成本估算
1. LLM 使用 Gemini 3 Flash。
2. 成本主要来自输入与输出 token。
3. 语义检索需额外 embedding 成本。

## 风险与应对
1. Notion 页面过大：按月分父页面或定期归档。
2. 召回过多导致上下文过长：限制 top-k。
3. 数据库膨胀：设置保留策略或冷热分层。

## 下一步计划
1. 确认 Notion 页面模板与标题规则。
2. 确认后台配置页的具体字段。
3. 完成数据库初始化与向量扩展配置。

## 术语
1. 语义检索：基于向量相似度的检索方式。
2. 父页面：Notion 中承载每日子页面的页面。
3. pgvector：Postgres 的向量扩展。
