# 数据库设计文档

## 🗄️ 数据库概述

### 技术栈
- **数据库**: PostgreSQL 15.15
- **扩展**: pgvector 0.8.1 (向量支持)
- **连接池**: Node.js pg 模块
- **备份策略**: 每日自动备份（计划）

### 设计原则
1. **向量优先** - 所有需要语义检索的表都包含向量字段
2. **关系完整** - 使用外键约束保证数据完整性
3. **性能优化** - 为常用查询创建索引
4. **可扩展性** - 表结构支持未来功能扩展
5. **安全性** - 权限控制和数据加密

## 📊 表结构设计

### 1. users - 用户表
存储Telegram用户的基本信息。

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `id`: 主键，UUID格式
- `telegram_id`: Telegram用户ID，唯一
- `username`: Telegram用户名（可选）
- `created_at`: 创建时间
- `updated_at`: 更新时间

**索引**:
- 主键索引: `users_pkey`
- 唯一索引: `users_telegram_id_key` (telegram_id)

### 2. profiles - 用户画像表
存储用户的个性化配置和目标。

```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    goals TEXT,
    status TEXT,
    preferences JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `id`: 主键，UUID格式
- `user_id`: 外键，关联users表
- `goals`: 用户目标（文本）
- `status`: 用户状态
- `preferences`: 用户偏好设置（JSON格式）
- `created_at`: 创建时间
- `updated_at`: 更新时间（自动更新）

**特性**:
- 外键约束: 用户删除时级联删除画像
- JSONB字段: 支持灵活的用户偏好设置
- 自动更新: 通过触发器自动更新updated_at

### 3. messages - 消息表
存储所有对话消息，支持向量检索。

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) CHECK (role IN ('user', 'assistant', 'system')),
    content TEXT,
    embedding VECTOR(768),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB
);
```

**字段说明**:
- `id`: 主键，UUID格式
- `user_id`: 外键，关联users表
- `role`: 消息角色（user/assistant/system）
- `content`: 消息内容
- `embedding`: 向量嵌入（768维）
- `created_at`: 创建时间
- `metadata`: 消息元数据（JSON格式）

**约束**:
- 外键约束: 用户删除时级联删除消息
- 检查约束: role字段只能是指定值
- 向量维度: 768维，与常用embedding模型兼容

### 4. knowledge_chunks - 知识片段表
存储用户注入的外部知识，支持向量检索。

```sql
CREATE TABLE knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    content TEXT,
    source VARCHAR(255),
    embedding VECTOR(768),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `id`: 主键，UUID格式
- `user_id`: 外键，关联users表
- `content`: 知识内容
- `source`: 知识来源
- `embedding`: 向量嵌入（768维）
- `created_at`: 创建时间

**用途**:
- 用户自定义知识库
- 支持语义检索
- 按用户隔离数据

### 5. sync_jobs - 同步任务表
记录所有同步任务的状态，如Notion归档。

```sql
CREATE TABLE sync_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_type VARCHAR(50),
    date_key DATE,
    status VARCHAR(20) CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
    details JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE
);
```

**字段说明**:
- `id`: 主键，UUID格式
- `job_type`: 任务类型（如'notion_sync'）
- `date_key`: 任务日期
- `status`: 任务状态
- `details`: 任务详情（JSON格式）
- `created_at`: 创建时间
- `completed_at`: 完成时间

**约束**:
- 检查约束: status字段只能是指定值
- 日期索引: 支持按日期查询

## 🔍 索引设计

### 功能索引
1. **用户消息索引**
   ```sql
   CREATE INDEX idx_messages_user_created ON messages(user_id, created_at DESC);
   ```
   - 用途: 按用户和时间查询消息
   - 优化: 降序排列，获取最新消息

2. **同步任务日期索引**
   ```sql
   CREATE INDEX idx_sync_jobs_date ON sync_jobs(date_key);
   ```
   - 用途: 按日期查询同步任务
   - 优化: 日期范围查询

### 向量索引
1. **消息向量索引**
   ```sql
   CREATE INDEX idx_messages_embedding ON messages USING ivfflat (embedding vector_cosine_ops);
   ```
   - 类型: ivfflat (倒排文件平面索引)
   - 距离度量: 余弦相似度
   - 用途: 消息语义检索

2. **知识向量索引**
   ```sql
   CREATE INDEX idx_knowledge_embedding ON knowledge_chunks USING ivfflat (embedding vector_cosine_ops);
   ```
   - 类型: ivfflat
   - 距离度量: 余弦相似度
   - 用途: 知识语义检索

**向量索引说明**:
- ivfflat索引适合中等规模数据集
- 余弦相似度适合文本语义检索
- 索引在数据量较少时会有警告（正常现象）

## 🔄 触发器设计

### 自动更新时间触发器
```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为profiles表添加触发器
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON profiles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**功能**:
- 自动更新updated_at字段
- 保证数据更新时间准确性
- 减少手动更新代码

## 🗺️ 数据关系图

```
users
  │
  ├── profiles (1:1)
  │
  ├── messages (1:N)
  │     │
  │     └── embedding (向量检索)
  │
  └── knowledge_chunks (1:N)
        │
        └── embedding (向量检索)

sync_jobs (独立表，记录任务状态)
```

**关系说明**:
- 一个用户对应一个画像（一对一）
- 一个用户有多条消息（一对多）
- 一个用户有多个知识片段（一对多）
- 消息和知识片段都支持向量检索
- 同步任务独立记录，不直接关联用户

## ⚡ 性能优化

### 查询优化
1. **分页查询**: 所有列表查询都支持分页
2. **索引覆盖**: 常用查询路径都有索引支持
3. **向量优化**: 限制向量检索结果数量
4. **连接优化**: 使用INNER JOIN代替子查询

### 存储优化
1. **JSONB字段**: 使用JSONB存储灵活数据
2. **向量压缩**: pgvector支持向量压缩
3. **分区考虑**: 消息表可按时间分区
4. **归档策略**: 旧数据可归档到历史表

### 维护优化
1. **自动清理**: 可配置数据保留策略
2. **索引重建**: 定期重建向量索引
3. **统计更新**: 自动更新查询统计
4. **备份策略**: 自动备份关键数据

## 🔒 安全设计

### 数据安全
1. **外键约束**: 保证数据完整性
2. **权限控制**: 数据库用户权限最小化
3. **数据加密**: 敏感字段可加密存储
4. **审计日志**: 重要操作记录日志

### 访问安全
1. **连接池**: 限制并发连接数
2. **查询超时**: 设置查询超时时间
3. **输入验证**: 所有输入参数验证
4. **SQL注入防护**: 使用参数化查询

## 📈 扩展性考虑

### 水平扩展
1. **读写分离**: 主从复制支持
2. **分片策略**: 可按用户ID分片
3. **缓存层**: Redis缓存热点数据
4. **CDN集成**: 静态资源CDN加速

### 功能扩展
1. **插件架构**: 支持功能插件
2. **Webhook支持**: 外部系统集成
3. **API扩展**: RESTful API设计
4. **监控集成**:  Prometheus监控

## 🧪 测试数据

### 测试用户
```sql
-- 插入测试用户
INSERT INTO users (telegram_id, username) 
VALUES (7927819221, '🍎')
ON CONFLICT (telegram_id) DO NOTHING;
```

### 测试消息
```sql
-- 插入测试消息（带向量）
INSERT INTO messages (user_id, role, content, embedding)
VALUES (
    (SELECT id FROM users WHERE telegram_id = 7927819221),
    'user',
    '数据库测试消息',
    '[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8]'::vector
);
```

## 📋 维护任务

### 日常维护
1. **备份检查**: 每日检查备份状态
2. **索引状态**: 每周检查索引状态
3. **性能监控**: 实时监控查询性能
4. **日志清理**: 定期清理旧日志

### 定期维护
1. **统计更新**: 每日更新查询统计
2. **索引重建**: 每月重建向量索引
3. **数据归档**: 每季度归档旧数据
4. **安全审计**: 每半年安全审计

---
**设计版本**: v1.0
**设计时间**: 2026-02-25
**设计状态**: ✅ 已实现
**维护者**: 小苹果 🍎